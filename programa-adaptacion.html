<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infografía — seleccionar por inicio y fin</title>

<!-- Dependencias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  body{font-family:Inter, Arial, sans-serif;margin:0;background:#f7f9fb;color:#222;}
  .container{max-width:1320px;margin:18px auto;padding:14px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;align-items:center}
  input[type=file]{display:inline-block}
  button{background:#1565c0;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#444}
  button.success{background:#2e7d32}
  button.danger{background:#c62828}
  .status{color:#555;font-size:13px;margin-left:8px}
  .mainGrid{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:12px;margin-top:6px}
  .panel{background:#fff;border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(11,22,39,0.07);overflow:auto;min-height:520px}
  .viewer{display:flex;flex-direction:column;gap:8px;align-items:center;padding:12px}
  .pageCanvas{border-radius:6px;box-shadow:0 6px 18px rgba(3,10,20,0.06);max-width:100%}
  .pagesList{display:flex;flex-direction:column;gap:6px}
  .textPanel{font-size:14px;padding:12px}
  .pageTitle{font-weight:600;margin-bottom:6px;color:#1e88e5}
  .token{display:inline-block; padding:2px 4px; margin:1px; border-radius:4px; cursor:pointer; user-select:none}
  .token:hover{background:rgba(21,101,192,0.06)}
  .token.start{outline:2px dashed #1565c0; background:rgba(21,101,192,0.06)}
  .token.highlight{background:linear-gradient(90deg,#ffd54f,#ffca28); box-shadow:inset 0 -2px 0 rgba(0,0,0,0.04);}
  .token.sopa-selected{background:linear-gradient(90deg,#a5d6a7,#81c784); box-shadow:inset 0 -2px 0 rgba(0,0,0,0.04);}
  .infBoard{padding:20px;background:#f0f7ff;border-radius:8px;min-height:420px}
  .word-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .word-item{padding:6px 12px;background:#e3f2fd;border-radius:16px;cursor:pointer;user-select:none;display:flex;align-items:center;gap:6px}
  .word-item.selected{background:#bbdefb;font-weight:bold;outline:2px solid #1565c0}
  .word-item:hover{background:#bbdefb}
  .sopa-controls{margin-top:15px;padding-top:15px;border-top:1px solid #ddd}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .remove-word{color:#c62828;cursor:pointer;font-weight:bold;padding:0 4px;}
  .instructions{font-size:13px;color:#666;margin-top:8px;padding:8px;background:#f5f5f5;border-radius:6px;}
  .counter{font-size:13px;color:#555;margin-bottom:8px;}
  .selection-mode{background:#ffecb3;padding:4px 8px;border-radius:4px;font-size:12px;margin-left:10px;}
  .size-controls {display: flex; align-items: center; gap: 8px; margin-top: 10px;}
  .size-controls label {font-size: 13px;}
  .size-controls input {width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 id="pageTitle">Infografía — marcar inicio y fin</h1>
    <div class="controls">
      <input id="pdfFile" type="file" accept="application/pdf">
      <button id="loadBtn">Cargar PDF</button>
      <button id="clearBtn">Limpiar</button>
      <button id="downloadBtn" class="secondary">Descargar PDF (con sopa de letras)</button>
      <span id="status" class="status"></span>
      <span id="selectionMode" class="selection-mode">Modo: Selección de frases</span>
    </div>
  </header>

  <div class="mainGrid">
    <div class="panel viewer" id="viewerPanel">
      <div><strong>Visualizador PDF</strong></div>
      <div id="viewerMeta" style="font-size:13px;color:#555"></div>
      <div id="pagesContainer" class="pagesList" style="width:100%;align-items:center; padding-top:6px"></div>
    </div>

    <div class="panel textPanel" id="textPanel">
      <div class="section-title">
        <strong>Texto</strong>
        <div class="counter" id="textCounter">Palabras: 0 | Seleccionadas: 0</div>
      </div>
      <div class="instructions">
        <div>
          <input type="radio" id="modePhrase" name="selectionMode" checked>
          <label for="modePhrase">Selección de frases (clic: inicio → clic: fin)</label>
        </div>
        <div>
          <input type="radio" id="modeWord" name="selectionMode">
          <label for="modeWord">Selección para sopa de letras (clic en palabras)</label>
        </div>
      </div>
      <div id="textPages" style="margin-top:8px"></div>
    </div>

    <div class="panel" id="infPanel">
      <div class="section-title">
        <strong>Infografía — frases seleccionadas</strong>
      </div>
      <div id="infBoard" class="infBoard" aria-live="polite"></div>
      
      <div class="sopa-controls">
        <div class="section-title">
          <strong>Palabras para la sopa de letras</strong>
          <div>
            <button id="autoSelectBtn" class="success">Seleccionar automáticamente</button>
            <button id="clearWordsBtn" class="danger">Limpiar palabras</button>
          </div>
        </div>
        <div id="selectedWordsInfo" class="counter">
          Seleccionadas: <span id="wordsCount">0</span>/<span id="maxWords">15</span> palabras
        </div>
        <div class="size-controls">
          <label for="fontSize">Tamaño de letra:</label>
          <input type="number" id="fontSize" value="14" min="8" max="20">
        </div>
        <div id="wordsContainer" class="word-list"></div>
      </div>
    </div>
  </div>
</div>

<script>
const PDFJS = window['pdfjsLib'];
PDFJS.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const MAX_PAGES = 40;
let loadedPdf = null, pagesTokens = [], selections = [], activeStart = null;
let currentFileName = "Infografía";
let selectedWords = [];
let allWordsCount = 0;
let currentMode = 'phrase'; // 'phrase' o 'word'
let fontSize = 14; // Tamaño de fuente para la sopa de letras

function setStatus(msg, timeout=3000){
  const s=document.getElementById('status');
  s.textContent=msg;
  if(timeout) setTimeout(()=>{if(s.textContent===msg) s.textContent='';},timeout);
}

function updateSelectionMode() {
  const modeElement = document.getElementById('selectionMode');
  if (currentMode === 'phrase') {
    modeElement.textContent = 'Modo: Selección de frases';
  } else {
    modeElement.textContent = 'Modo: Selección para sopa de letras';
  }
}

/* --- carga PDF y tokenización --- */
async function loadPdfFile(file){
  currentFileName = file.name.replace(/\.pdf$/i,"");
  document.getElementById("pageTitle").textContent = "Infografía — " + currentFileName;

  const arrayBuffer=await file.arrayBuffer();
  const loading=PDFJS.getDocument({data:arrayBuffer});
  loadedPdf=await loading.promise;
  const total=Math.min(loadedPdf.numPages,MAX_PAGES);
  document.getElementById('viewerMeta').textContent=`Páginas: ${loadedPdf.numPages}`;
  const pagesContainer=document.getElementById('pagesContainer');
  const textPages=document.getElementById('textPages');
  pagesContainer.innerHTML=''; textPages.innerHTML='';
  pagesTokens=[]; selections=[]; activeStart=null;
  document.getElementById('infBoard').innerHTML='';
  selectedWords = [];
  allWordsCount = 0;
  updateWordsContainer();

  for(let p=1;p<=total;p++){
    const page=await loadedPdf.getPage(p);
    const viewport=page.getViewport({scale:1.2});
    const canvas=document.createElement('canvas');
    canvas.className='pageCanvas';
    canvas.width=Math.floor(viewport.width);
    canvas.height=Math.floor(viewport.height);
    const ctx=canvas.getContext('2d',{alpha:false});
    await page.render({canvasContext:ctx,viewport}).promise;
    const pageWrapper=document.createElement('div');
    pageWrapper.appendChild(canvas);
    pagesContainer.appendChild(pageWrapper);

    const textContent=await page.getTextContent();
    const tokens=[]; const spanNodes=[];
    textContent.items.forEach(item=>{
      const parts=item.str.split(/\s+/).filter(Boolean);
      parts.forEach(part=>{
        tokens.push(part);
        allWordsCount++;
      });
    });
    
    const pageTextDiv=document.createElement('div');
    const pageTitle=document.createElement('div');
    pageTitle.className='pageTitle';
    pageTitle.textContent=`Página ${p}`;
    pageTextDiv.appendChild(pageTitle);
    
    const tokensContainer=document.createElement('div');
    tokensContainer.setAttribute('data-page',p-1);
    tokens.forEach((t,idx)=>{
      const sp=document.createElement('span');
      sp.className='token'; 
      sp.textContent=t+' ';
      sp.dataset.page=(p-1); 
      sp.dataset.index=idx;
      sp.dataset.word=t.toUpperCase();
      
      // Evento para selección
      sp.addEventListener('click',(e)=>{
        if (currentMode === 'word') {
          // Modo selección de palabras para sopa
          toggleWordForSopa(t, p-1, idx, sp);
        } else {
          // Modo selección de frases
          handleTokenClick(p-1,idx);
        }
      });
      
      tokensContainer.appendChild(sp); 
      spanNodes.push(sp);
    });
    
    pageTextDiv.appendChild(tokensContainer);
    textPages.appendChild(pageTextDiv);
    pagesTokens.push({tokens,spanNodes});
  }
  
  // Actualizar contador de palabras
  document.getElementById('textCounter').textContent = `Palabras: ${allWordsCount} | Seleccionadas: ${selectedWords.length}`;
}

/* --- Gestión de palabras para sopa de letras --- */
function toggleWordForSopa(word, pageIndex, tokenIndex, element) {
  const cleanWord = word.toUpperCase().replace(/[^A-ZÁÉÍÓÚÜÑ]/gi, '');
  
  if (!cleanWord || cleanWord.length < 3) {
    setStatus('Palabra demasiado corta (mínimo 3 letras)', 2000);
    return;
  }
  
  // Verificar si la palabra ya está seleccionada
  const wordIndex = selectedWords.findIndex(w => w.word === cleanWord);
  
  if (wordIndex !== -1) {
    // Quitar la palabra de la selección
    selectedWords.splice(wordIndex, 1);
    element.classList.remove('sopa-selected');
    setStatus(`Palabra "${cleanWord}" eliminada de la sopa`, 2000);
  } else {
    // Añadir la palabra a la selección (si no hemos alcanzado el límite)
    const maxWords = parseInt(document.getElementById('maxWords').textContent);
    if (selectedWords.length >= maxWords) {
      setStatus(`Límite alcanzado (${maxWords} palabras máximo)`, 2000);
      return;
    }
    
    selectedWords.push({
      word: cleanWord,
      original: word,
      page: pageIndex,
      token: tokenIndex
    });
    
    element.classList.add('sopa-selected');
    setStatus(`Palabra "${cleanWord}" añadida a la sopa`, 2000);
  }
  
  updateWordsContainer();
}

function updateWordsContainer() {
  const container = document.getElementById('wordsContainer');
  const info = document.getElementById('wordsCount');
  container.innerHTML = '';
  
  info.textContent = selectedWords.length;
  
  // Actualizar también el contador general
  document.getElementById('textCounter').textContent = `Palabras: ${allWordsCount} | Seleccionadas: ${selectedWords.length}`;
  
  selectedWords.forEach((wordObj, index) => {
    const wordElement = document.createElement('div');
    wordElement.className = 'word-item selected';
    wordElement.innerHTML = `
      ${wordObj.word} 
      <span class="remove-word" title="Quitar palabra">×</span>
    `;
    
    wordElement.querySelector('.remove-word').addEventListener('click', (e) => {
      e.stopPropagation();
      // Quitar la clase de la palabra en el texto
      const pageTokens = pagesTokens[wordObj.page];
      if (pageTokens && pageTokens.spanNodes[wordObj.token]) {
        pageTokens.spanNodes[wordObj.token].classList.remove('sopa-selected');
      }
      
      selectedWords.splice(index, 1);
      updateWordsContainer();
      setStatus(`Palabra "${wordObj.word}" eliminada`, 2000);
    });
    
    container.appendChild(wordElement);
  });
  
  // Si no hay palabras seleccionadas, mostrar mensaje
  if (selectedWords.length === 0) {
    const emptyMsg = document.createElement('div');
    emptyMsg.textContent = 'No hay palabras seleccionadas. Cambia al modo de selección de palabras y haz clic en las palabras.';
    emptyMsg.style.color = '#999';
    emptyMsg.style.fontStyle = 'italic';
    container.appendChild(emptyMsg);
  }
}

function clearAllWords() {
  // Quitar todas las marcas de las palabras en el texto
  pagesTokens.forEach(page => {
    page.spanNodes.forEach(span => {
      span.classList.remove('sopa-selected');
    });
  });
  
  selectedWords = [];
  updateWordsContainer();
  setStatus('Todas las palabras eliminadas', 2000);
}

/* --- selección de frases --- */
function findSelectionContaining(pi,ti){
  return selections.find(s=>s.pageIndex===pi&&ti>=s.start&&ti<=s.end);
}

function markStartToken(pi,idx){ 
  if(activeStart){
    pagesTokens[activeStart.pageIndex].spanNodes[activeStart.index].classList.remove('start');
  } 
  activeStart={pageIndex:pi,index:idx}; 
  pagesTokens[pi].spanNodes[idx].classList.add('start');
}

function clearStartMark(){ 
  if(activeStart){
    pagesTokens[activeStart.pageIndex].spanNodes[activeStart.index].classList.remove('start');
  } 
  activeStart=null;
}

function highlightRange(pi,s,e){
  for(let i=s;i<=e;i++){
    pagesTokens[pi].spanNodes[i].classList.add('highlight');
  }
}

function unhighlightRange(pi,s,e){
  for(let i=s;i<=e;i++){
    pagesTokens[pi].spanNodes[i].classList.remove('highlight');
  }
}

function handleTokenClick(pi,ti){
  // Si ya hay una selección en este token, eliminarla
  const containing=findSelectionContaining(pi,ti);
  if(containing){
    removeSelection(containing);
    clearStartMark();
    return;
  }
  
  // Si no hay inicio de selección, marcar inicio
  if(!activeStart){
    markStartToken(pi,ti);
    setStatus('Inicio de selección marcado. Haz clic en la última palabra.', 2000);
    return;
  }
  
  // Si el inicio está en una página diferente, reiniciar selección
  if(pi!==activeStart.pageIndex){
    clearStartMark();
    markStartToken(pi,ti);
    setStatus('Selección reiniciada en nueva página. Haz clic en la última palabra.', 2000);
    return;
  }
  
  // Crear la selección
  const s=Math.min(activeStart.index,ti), e=Math.max(activeStart.index,ti);
  const page=pagesTokens[pi]; 
  const text=page.tokens.slice(s,e+1).join(' ');
  
  if(!text){
    clearStartMark();
    return;
  }
  
  const selObj={pageIndex:pi,start:s,end:e,text};
  selections.push(selObj); 
  highlightRange(pi,s,e);
  
  const preview=document.createElement('div');
  preview.textContent=text; 
  preview.style.background="#e3f2fd"; 
  preview.style.margin="4px 0"; 
  preview.style.padding="8px"; 
  preview.style.borderRadius="4px";
  preview.style.position = "relative";
  
  const removeBtn = document.createElement('button');
  removeBtn.textContent = "X";
  removeBtn.style.position = "absolute";
  removeBtn.style.top = "4px";
  removeBtn.style.right = "4px";
  removeBtn.style.background = "#f44336";
  removeBtn.style.color = "white";
  removeBtn.style.border = "none";
  removeBtn.style.borderRadius = "50%";
  removeBtn.style.width = "20px";
  removeBtn.style.height = "20px";
  removeBtn.style.fontSize = "12px";
  removeBtn.style.cursor = "pointer";
  removeBtn.style.padding = "0";
  removeBtn.addEventListener('click', () => {
    removeSelection(selObj);
    preview.remove();
  });
  
  preview.appendChild(removeBtn);
  document.getElementById('infBoard').appendChild(preview);
  
  clearStartMark();
  setStatus('Frase seleccionada: ' + text, 3000);
}

function removeSelection(sel){
  unhighlightRange(sel.pageIndex,sel.start,sel.end); 
  selections=selections.filter(s=>s!==sel);
}

function autoSelectWords() {
  // Primero limpiar selección actual
  clearAllWords();
  
  // Buscar palabras relevantes en todas las selecciones de frases
  const wordCounts = {};
  
  selections.forEach(sel => {
    const words = sel.text.split(/\s+/);
    words.forEach(word => {
      const cleanWord = word.toUpperCase().replace(/[^A-ZÁÉÍÓÚÜÑ]/gi, '');
      if (cleanWord.length >= 4) { // Palabras de 4+ caracteres
        if (!wordCounts[cleanWord]) {
          wordCounts[cleanWord] = 0;
        }
        wordCounts[cleanWord]++;
      }
    });
  });
  
  // Ordenar por frecuencia y seleccionar las más comunes
  const maxWords = parseInt(document.getElementById('maxWords').textContent);
  const sortedWords = Object.entries(wordCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, maxWords);
  
  // Añadir las palabras seleccionadas
  sortedWords.forEach(([word]) => {
    if (selectedWords.length < maxWords) {
      // Buscar la palabra en el texto para marcarla visualmente
      let found = false;
      for (let pageIndex = 0; pageIndex < pagesTokens.length && !found; pageIndex++) {
        const page = pagesTokens[pageIndex];
        for (let tokenIndex = 0; tokenIndex < page.tokens.length && !found; tokenIndex++) {
          const token = page.tokens[tokenIndex];
          if (token.toUpperCase().replace(/[^A-ZÁÉÍÓÚÜÑ]/gi, '') === word) {
            selectedWords.push({
              word: word,
              original: token,
              page: pageIndex,
              token: tokenIndex
            });
            
            // Marcar visualmente la palabra en el texto
            page.spanNodes[tokenIndex].classList.add('sopa-selected');
            found = true;
          }
        }
      }
    }
  });
  
  updateWordsContainer();
  setStatus('Palabras seleccionadas automáticamente desde las frases', 2000);
}

/* --- generar sopa de letras --- */
function generateWordSearch(words, size=15){
  const grid=Array.from({length:size},()=>Array(size).fill(''));
  const dirs=[[1,0],[0,1],[1,1],[1,-1],[-1,0],[0,-1],[-1,-1],[-1,1]];
  
  // Ordenar palabras de más larga a más corta para mejor colocación
  const sortedWords = [...words].sort((a, b) => b.length - a.length);
  
  for(const w of sortedWords){
    let placed=false, tries=0;
    while(!placed && tries<200){
      tries++;
      const dir=dirs[Math.floor(Math.random()*dirs.length)];
      const row=Math.floor(Math.random()*size);
      const col=Math.floor(Math.random()*size);
      let r=row,c=col,i=0,ok=true;
      while(i<w.length && r>=0&&c>=0&&r<size&&c<size){
        if(grid[r][c]!==''&&grid[r][c]!==w[i]){ok=false;break;}
        r+=dir[0]; c+=dir[1]; i++;
      }
      if(i===w.length && ok){
        r=row; c=col;
        for(const ch of w){grid[r][c]=ch; r+=dir[0]; c+=dir[1];}
        placed=true;
      }
    }
    if (!placed) {
      console.log(`No se pudo colocar la palabra: ${w}`);
    }
  }
  const alphabet="ABCDEFGHIJKLMNÑOPQRSTUVWXYZ";
  for(let r=0;r<size;r++) for(let c=0;c<size;c++) if(grid[r][c]==='') grid[r][c]=alphabet[Math.floor(Math.random()*alphabet.length)];
  return grid;
}

/* --- Botones y eventos --- */
document.getElementById('loadBtn').addEventListener('click', async ()=>{
  const fi=document.getElementById('pdfFile');
  if(!fi.files.length){setStatus('Selecciona un PDF.');return;}
  setStatus('Cargando...'); await loadPdfFile(fi.files[0]); setStatus('PDF cargado.');
});

document.getElementById('clearBtn').addEventListener('click',()=>{
  selections.forEach(s=>unhighlightRange(s.pageIndex,s.start,s.end));
  selections=[]; clearStartMark(); 
  document.getElementById('infBoard').innerHTML='';
  clearAllWords();
  setStatus('Selecciones limpiadas');
});

document.getElementById('autoSelectBtn').addEventListener('click', autoSelectWords);
document.getElementById('clearWordsBtn').addEventListener('click', clearAllWords);

// Cambio de modo de selección
document.getElementById('modePhrase').addEventListener('change', function() {
  if (this.checked) {
    currentMode = 'phrase';
    updateSelectionMode();
    setStatus('Modo: Selección de frases. Haz clic en la primera y última palabra de una frase.');
  }
});

document.getElementById('modeWord').addEventListener('change', function() {
  if (this.checked) {
    currentMode = 'word';
    updateSelectionMode();
    setStatus('Modo: Selección para sopa de letras. Haz clic en palabras para añadirlas o quitarlas.');
  }
});

// Control de tamaño de fuente para sopa de letras
document.getElementById('fontSize').addEventListener('change', function() {
  const newSize = parseInt(this.value);
  if (newSize >= 8 && newSize <= 20) {
    fontSize = newSize;
    setStatus(`Tamaño de letra cambiado a ${fontSize}pt.`);
  } else {
    this.value = fontSize;
    setStatus('El tamaño de letra debe estar entre 8 y 20.');
  }
});

// Inicializar modo de selección
updateSelectionMode();

/* --- Exportar PDF con tabla y sopa --- */
document.getElementById('downloadBtn').addEventListener('click',()=>{
  if(selectedWords.length === 0){
    setStatus('No hay palabras seleccionadas para la sopa de letras.');
    return;
  }
  
  const {jsPDF}=window.jspdf;
  // Cambiar a formato vertical (portrait) para A4
  const pdf=new jsPDF({unit:'pt',format:'a4',orientation:'portrait'});
  const pageW=pdf.internal.pageSize.getWidth();
  const margin = 40; // Márgenes laterales

  // Usar palabras seleccionadas para la sopa
  const chosen = selectedWords.map(w => w.word);
  
  // Página 1 - Infografía con frases seleccionadas
  pdf.setFontSize(16); 
  pdf.text(currentFileName, pageW/2, 30, {align:"center"});
  
  if (selections.length > 0) {
    // Configurar la tabla para formato vertical
    const data=selections.map((s,i)=>{
      let txt=s.text.split(/\s+/).map(t=>{
        if(chosen.includes(t.toUpperCase())) return "**"+t+"**"; // negrita
        return t;
      }).join(" ");
      return [i+1, {content: txt, styles: {fontStyle: 'normal'}}];
    });
    
    pdf.autoTable({
      startY:45,
      head:[['#','Frase']],
      body:data,
      styles:{
        font:"helvetica",
        fontSize:10,
        cellPadding:4,
        valign:"middle",
        overflow:"linebreak",
        halign:"left",
        lineColor:[0,0,0],
        lineWidth:0.3
      },
      headStyles:{fillColor:[21,101,192],textColor:[255,255,255],fontStyle:"bold"},
      alternateRowStyles:{fillColor:[230,247,255]},
      columnStyles:{
        0:{cellWidth:30, fillColor:[255,235,238], halign: 'center'},
        1:{cellWidth:pageW - margin*2 - 40} // Ancho ajustado para vertical
      },
      margin:{left:margin, right:margin},
      didParseCell: function(data) {
        if (data.section === 'body' && data.column.index === 1) {
          let text = data.cell.raw;
          if (typeof text === 'string') {
            const parts = text.split(/(\*\*.+?\*\*)/g);
            data.cell.text = [];
            data.cell.styles = {};
            
            for (let part of parts) {
              if (part.startsWith('**') && part.endsWith('**')) {
                data.cell.text.push({text: part.replace(/\*\*/g, ''), styles: {fontStyle: 'bold'}});
              } else if (part) {
                data.cell.text.push({text: part, styles: {fontStyle: 'normal'}});
              }
            }
          }
        }
      },
      // Ajustar altura de las filas automáticamente
      didDrawPage: function(data) {
        // Añadir número de página
        pdf.setFontSize(10);
        pdf.text('Página 1 - Infografía', pageW/2, pdf.internal.pageSize.getHeight() - 20, {align: 'center'});
      }
    });
  } else {
    pdf.setFontSize(12);
    pdf.text("No hay frases seleccionadas", margin, 60);
    pdf.setFontSize(10);
    pdf.text('Página 1 - Infografía', pageW/2, pdf.internal.pageSize.getHeight() - 20, {align: 'center'});
  }

  // Página 2 con sopa de letras
  pdf.addPage("a4","portrait");
  pdf.setFontSize(16); 
  pdf.text("Sopa de letras", pageW/2, 30, {align:"center"});
  pdf.setFontSize(12); 
  pdf.text("Palabras a buscar:", margin, 50);
  pdf.setFontSize(10);
  
  // Mostrar palabras en varias líneas si es necesario
  const wordsPerLine = 4;
  let y = 70;
  for (let i = 0; i < chosen.length; i += wordsPerLine) {
    const lineWords = chosen.slice(i, i + wordsPerLine);
    pdf.text(lineWords.join(", "), margin, y);
    y += 15;
  }
  
  // Generar y mostrar la sopa de letras
  const grid = generateWordSearch(chosen, 15);
  pdf.setFont("courier", "normal");
  pdf.setFontSize(fontSize); // Usar el tamaño de fuente configurado
  
  // Calcular tamaño y posición de la sopa de letras
  const cellSize = fontSize * 0.8; // Tamaño aproximado de cada celda
  const gridWidth = 15 * cellSize;
  const gridX = (pageW - gridWidth) / 2;
  y = 130; // Posición vertical inicial
  
  for(let r = 0; r < grid.length; r++){ 
    pdf.text(grid[r].join(" "), gridX, y); 
    y += fontSize * 0.9; // Espaciado proporcional al tamaño de fuente
  }
  
  // Añadir número de página
  pdf.setFontSize(10);
  pdf.text('Página 2 - Sopa de letras', pageW/2, pdf.internal.pageSize.getHeight() - 20, {align: 'center'});

  pdf.save(currentFileName + ".pdf");
  setStatus(`PDF descargado con infografía y sopa de letras con letras de ${fontSize}pt.`);
});
</script>
</body>
</html>