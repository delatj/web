<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Creador de P√°ginas Web</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
    }
    
    h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.5rem;
      color: #2c3e50;
    }
    
    #toolbar {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-bottom: 2px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    
    #toolbar button, #toolbar select, #toolbar input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background-color: #fdfdfd;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out;
      min-height: 40px;
    }
    
    #toolbar button:hover, #toolbar select:hover, #toolbar input:hover {
      background-color: #f0f0f0;
      transform: translateY(-1px);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
    }
    
    #editor {
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 300px;
      margin-top: 10px;
      background: #e6f7ff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      outline: none;
    }
    
    .pdf-container, .image-container, .audio-block {
      border: 1px solid #ccc;
      margin: 10px 0;
      padding: 10px;
      background: #fafafa;
      position: relative;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
      border-radius: 6px;
      text-align: left;
      width: 100%;
      overflow-x: auto;
    }
    
    .pdf-controls, .image-controls {
      text-align: center;
      margin-top: 8px;
    }
    
    .pdf-controls button, .image-controls button, .audio-block button {
      margin: 0 5px;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      min-height: 32px;
    }
    
    .pdf-controls button:hover, .image-controls button:hover, .audio-block button:hover {
      transform: translateY(-1px);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    
    .pdf-container img, .image-container img {
      display: block;
      margin: 10px 0;
      border: 1px solid #aaa;
      max-width: 100%;
      transition: transform 0.2s;
    }
    
    .page-number {
      text-align: center;
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }
    
    /* Estilos para m√≥viles */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      h2 {
        font-size: 1.3rem;
        margin-bottom: 10px;
      }
      
      #toolbar {
        padding: 8px;
        gap: 4px;
      }
      
      #toolbar button, #toolbar select, #toolbar input {
        padding: 6px 8px;
        font-size: 13px;
        min-height: 36px;
        flex: 1 1 calc(33.333% - 8px);
      }
      
      #editor {
        padding: 10px;
        min-height: 250px;
      }
      
      .mobile-menu {
        display: flex;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 8px;
      }
      
      .mobile-menu button {
        flex: 1;
        margin: 0 2px;
      }
      
      .mobile-submenu {
        display: none;
        width: 100%;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #ddd;
      }
      
      .mobile-submenu.active {
        display: flex;
      }
      
      .mobile-submenu button, .mobile-submenu select {
        flex: 1 1 calc(50% - 4px);
      }
      
      #pageTitle {
        width: 100%;
        margin-top: 8px;
      }
      
      #bgColor {
        width: 100%;
        margin-top: 8px;
      }
    }
    
    @media (max-width: 480px) {
      #toolbar button, #toolbar select, #toolbar input {
        flex: 1 1 calc(50% - 6px);
        font-size: 12px;
        padding: 5px 6px;
      }
      
      .mobile-submenu button, .mobile-submenu select {
        flex: 1 1 100%;
      }
    }
    
    /* Estilos para la grabaci√≥n de audio */
    .recording-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: red;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .recording-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .recording-timer {
      font-size: 14px;
      color: #666;
      margin: 0 10px;
      display: flex;
      align-items: center;
    }
    
    /* Selector de color mejorado */
    .color-picker-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .color-preview {
      width: 20px;
      height: 20px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    
    /* Modal de grabaci√≥n */
    .recording-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .recording-modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 90%;
      width: 400px;
    }
    
    .recording-status {
      margin: 15px 0;
      font-size: 16px;
    }
    
    .recording-time {
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
      color: #d32f2f;
    }
    
    .permission-help {
      font-size: 12px;
      color: #666;
      margin-top: 15px;
      text-align: left;
    }
    
    .permission-help ul {
      margin: 5px 0;
      padding-left: 20px;
    }
    
    .hidden {
      display: none !important;
    }
  </style>

  <!-- PDF.js desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
  </script>
</head>
<body>
  <h2>Editor de P√°ginas Web HTML</h2>
  <div id="toolbar">
    <div class="mobile-menu">
      <button onclick="toggleSubmenu('formatMenu')">Formato</button>
      <button onclick="toggleSubmenu('insertMenu')">Insertar</button>
      <button onclick="toggleSubmenu('layoutMenu')">Dise√±o</button>
    </div>
    
    <div id="formatMenu" class="mobile-submenu">
      <button onclick="formatText('bold')">Negrita</button>
      <button onclick="formatText('italic')">Cursiva</button>
      <button onclick="formatText('underline')">Subrayado</button>
      <select id="fontFamilySelect" onchange="applyFontFamily()">
        <option value="Arial">Arial</option>
        <option value="Times New Roman">Times</option>
        <option value="Georgia">Georgia</option>
        <option value="Courier New">Courier</option>
        <option value="Verdana">Verdana</option>
      </select>
      <select id="fontSizeSelect" onchange="applyFontSize()">
        <option value="3">3</option>
        <option value="4" selected>4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
      <div class="color-picker-container">
        <span>Color:</span>
        <div class="color-preview" id="colorPreview" style="background-color: black;"></div>
        <input type="color" id="textColorPicker" onchange="changeTextColor(this.value)" value="#000000">
      </div>
    </div>
    
    <div id="insertMenu" class="mobile-submenu">
      <button onclick="insertLink()">Enlace</button>
      <button onclick="insertTable()">Tabla</button>
      <button onclick="insertImage()">Imagen</button>
      <button onclick="insertAudio()">Audio</button>
      <button onclick="startRecording()" id="recordBtn">Grabar Audio</button>
      <button onclick="insertPDF()">PDF</button>
    </div>
    
    <div id="layoutMenu" class="mobile-submenu">
      <button onclick="formatText('justifyLeft')">Izquierda</button>
      <button onclick="formatText('justifyCenter')">Centrar</button>
      <button onclick="formatText('justifyRight')">Derecha</button>
      <button onclick="formatText('justifyFull')">Justificar</button>
      <button onclick="formatText('insertOrderedList')">Lista Num.</button>
      <button onclick="formatText('insertUnorderedList')">Lista Vi√±.</button>
      <button onclick="formatText('undo')">Deshacer</button>
      <button onclick="formatText('redo')">Rehacer</button>
    </div>
    
    <div style="width: 100%; display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
      <div style="flex: 1 1 100%; display: flex; gap: 5px;">
        <label style="flex: 1; display: flex; align-items: center; font-size: 14px;">
          T√≠tulo:
          <input type="text" id="pageTitle" placeholder="Mi p√°gina web" style="flex: 1; margin-left: 5px;">
        </label>
        <span id="titleError" style="color: red; font-size: 12px; display: flex; align-items: center;"></span>
      </div>
      
      <div style="flex: 1 1 100%; display: flex; gap: 5px; margin-top: 5px;">
        <label style="flex: 1; display: flex; align-items: center; font-size: 14px;">
          Fondo:
          <select id="bgColor" style="flex: 1; margin-left: 5px;">
            <option value="white">Blanco</option>
            <option value="#f5f5f5">Gris claro</option>
            <option value="#e6f7ff" selected>Celeste</option>
            <option value="#e6ffe6">Verde claro</option>
            <option value="#ffffe6">Amarillo claro</option>
            <option value="#f9e6ff">Lavanda</option>
            <option value="#ffe6f2">Rosa claro</option>
          </select>
        </label>
      </div>
      
      <div style="flex: 1 1 100%; display: flex; gap: 5px; margin-top: 5px;">
        <button onclick="saveFile()" style="flex: 1;">Guardar</button>
        <button onclick="loadFile()" style="flex: 1;">Cargar</button>
        <button onclick="downloadHTML()" style="flex: 1;">Descargar HTML</button>
      </div>
    </div>
  </div>

  <div id="editor" contenteditable="true"></div>

  <!-- Modal para grabaci√≥n de audio -->
  <div id="recordingModal" class="recording-modal hidden">
    <div class="recording-modal-content">
      <h3>Grabaci√≥n de Audio</h3>
      <div class="recording-status" id="recordingStatus">Preparando grabaci√≥n...</div>
      <div class="recording-time" id="recordingTime">00:00</div>
      <div class="recording-controls">
        <button id="stopRecordingBtn" onclick="stopRecording()" disabled>Detener Grabaci√≥n</button>
        <button onclick="cancelRecording()">Cancelar</button>
      </div>
      <div class="permission-help" id="permissionHelp">
        <p><strong>Si no puedes grabar:</strong></p>
        <ul>
          <li>Aseg√∫rate de que el sitio tenga permiso para usar el micr√≥fono</li>
          <li>En m√≥vil: toca "Permitir" cuando se solicite</li>
          <li>En Chrome: haz clic en el icono üîí en la barra de direcciones</li>
          <li>Verifica que tu micr√≥fono est√© funcionando</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let pdfCount = 0;
    let imgCount = 0;
    let audioCount = 0;
    let indexItems = [];
    let activeSubmenu = null;
    
    // Variables para grabaci√≥n de audio
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recordingTimer = null;
    let recordingStartTime = null;
    let audioStream = null;

    // Funci√≥n mejorada para mantener la selecci√≥n
    function saveSelection() {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        return selection.getRangeAt(0);
      }
      return null;
    }

    function restoreSelection(range) {
      if (range) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }
    }

    // Funci√≥n mejorada para formato de texto
    function formatText(command, value = null) {
      const editor = document.getElementById('editor');
      const selection = saveSelection();
      
      // Asegurarse de que el editor tenga el foco
      editor.focus();
      
      if (selection) {
        restoreSelection(selection);
      }
      
      try {
        if (value) {
          document.execCommand(command, false, value);
        } else {
          document.execCommand(command, false, null);
        }
      } catch (e) {
        console.error('Error ejecutando comando:', e);
      }
      
      // Mantener el foco en el editor
      editor.focus();
    }

    // Funciones espec√≠ficas para fuente y tama√±o
    function applyFontFamily() {
      const fontFamily = document.getElementById('fontFamilySelect').value;
      formatText('fontName', fontFamily);
    }

    function applyFontSize() {
      const fontSize = document.getElementById('fontSizeSelect').value;
      formatText('fontSize', fontSize);
    }

    function changeTextColor(color) {
      document.getElementById('colorPreview').style.backgroundColor = color;
      formatText('foreColor', color);
    }

    function insertLink() {
      const url = prompt("Introduce la URL:", "https://");
      if (url) {
        formatText('createLink', url);
      }
    }
    
    function insertTable() {
      const rows = parseInt(prompt("N√∫mero de filas:", "2")) || 2;
      const cols = parseInt(prompt("N√∫mero de columnas:", "2")) || 2;
      
      let tableHTML = '<table border="1" style="border-collapse: collapse; width: 100%;">';
      for (let i = 0; i < rows; i++) {
        tableHTML += '<tr>';
        for (let j = 0; j < cols; j++) {
          tableHTML += '<td style="padding: 8px;">&nbsp;</td>';
        }
        tableHTML += '</tr>';
      }
      tableHTML += '</table>';
      
      // Insertar tabla manteniendo la selecci√≥n
      const selection = saveSelection();
      document.getElementById('editor').focus();
      if (selection) {
        restoreSelection(selection);
      }
      document.execCommand('insertHTML', false, tableHTML);
      document.getElementById('editor').focus();
    }

    // Funci√≥n para mostrar/ocultar submen√∫s en m√≥viles
    function toggleSubmenu(menuId) {
      const menu = document.getElementById(menuId);
      
      // Cerrar cualquier submen√∫ abierto
      if (activeSubmenu && activeSubmenu !== menu) {
        activeSubmenu.classList.remove('active');
      }
      
      // Alternar el submen√∫ actual
      menu.classList.toggle('active');
      activeSubmenu = menu.classList.contains('active') ? menu : null;
    }

    // --- Insertar imagen CON COMPRESI√ìN ---
    function insertImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = evt => {
          // Crear imagen temporal para compresi√≥n
          const img = new Image();
          img.onload = function() {
            // Crear canvas para comprimir la imagen
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Reducir tama√±o a la mitad
            const maxWidth = img.width / 2;
            const maxHeight = img.height / 2;
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Dibujar imagen comprimida
            ctx.drawImage(img, 0, 0, width, height);
            
            // Obtener imagen comprimida en formato JPEG con calidad reducida
            const compressedDataURL = canvas.toDataURL('image/jpeg', 0.6);
            
            imgCount++;
            const id = `img-${imgCount}`;

            const container = document.createElement("div");
            container.className = "image-container";
            container.id = id;

            const displayImg = document.createElement("img");
            displayImg.src = compressedDataURL;
            displayImg.style.maxWidth = "100%";
            displayImg.alt = "Imagen insertada";
            container.appendChild(displayImg);

            const controls = document.createElement("div");
            controls.className = "image-controls";
            let scale = 1.0;

            const zoomIn = document.createElement("button");
            zoomIn.textContent = "+";
            zoomIn.onclick = () => {
              scale = Math.min(2.0, scale + 0.2);
              displayImg.style.maxWidth = (scale * 100) + "%";
            };

            const zoomOut = document.createElement("button");
            zoomOut.textContent = "‚Äì";
            zoomOut.onclick = () => {
              scale = Math.max(0.1, scale - 0.2);
              displayImg.style.maxWidth = (scale * 100) + "%";
            };

            const del = document.createElement("button");
            del.textContent = "Eliminar";
            del.onclick = () => container.remove();

            controls.appendChild(zoomIn);
            controls.appendChild(zoomOut);
            controls.appendChild(del);
            container.appendChild(controls);

            document.getElementById("editor").appendChild(container);

            indexItems.push({ id: id, name: file.name });
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    // --- Insertar audio ---
    function insertAudio() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'audio/*';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = evt => {
          audioCount++;
          const id = `audio-${audioCount}`;
          const block = document.createElement("div");
          block.className = "audio-block";
          block.id = id;
          
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = evt.target.result;
          audio.style.width = "100%";
          
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Eliminar";
          deleteBtn.onclick = () => block.remove();
          
          block.appendChild(audio);
          block.appendChild(deleteBtn);
          document.getElementById("editor").appendChild(block);
          
          indexItems.push({ id: id, name: file.name });
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    // --- Grabaci√≥n de audio MEJORADA ---
    async function startRecording() {
      const modal = document.getElementById('recordingModal');
      const status = document.getElementById('recordingStatus');
      const stopBtn = document.getElementById('stopRecordingBtn');
      
      // Mostrar modal
      modal.classList.remove('hidden');
      status.textContent = "Solicitando permiso para el micr√≥fono...";
      stopBtn.disabled = true;
      
      try {
        // Solicitar permiso para el micr√≥fono
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          } 
        });
        
        status.textContent = "Grabando... Habla ahora";
        stopBtn.disabled = false;
        
        // Configurar el grabador
        mediaRecorder = new MediaRecorder(audioStream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          // Crear el blob de audio
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          
          // Insertar el audio en el editor
          audioCount++;
          const id = `rec-${audioCount}`;
          const block = document.createElement("div");
          block.className = "audio-block";
          block.id = id;
          
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = audioUrl;
          audio.style.width = "100%";
          
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Eliminar";
          deleteBtn.onclick = () => block.remove();
          
          block.appendChild(audio);
          block.appendChild(deleteBtn);
          document.getElementById("editor").appendChild(block);
          
          indexItems.push({ id: id, name: `Grabaci√≥n-${audioCount}` });
          
          // Limpiar
          cleanupRecording();
        };
        
        // Iniciar grabaci√≥n
        mediaRecorder.start(100);
        isRecording = true;
        
        // Iniciar temporizador
        recordingStartTime = Date.now();
        updateRecordingTimer();
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
      } catch (error) {
        console.error("Error al acceder al micr√≥fono:", error);
        status.textContent = "Error: No se pudo acceder al micr√≥fono";
        
        if (error.name === 'NotAllowedError') {
          document.getElementById('permissionHelp').classList.remove('hidden');
        } else if (error.name === 'NotFoundError') {
          status.textContent = "Error: No se encontr√≥ ning√∫n micr√≥fono";
        } else if (error.name === 'NotSupportedError') {
          status.textContent = "Error: La grabaci√≥n no es compatible con este navegador";
        }
        
        stopBtn.classList.add('hidden');
      }
    }
    
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
        
        document.getElementById('recordingModal').classList.add('hidden');
      }
    }
    
    function cancelRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
      }
      
      cleanupRecording();
      document.getElementById('recordingModal').classList.add('hidden');
    }
    
    function cleanupRecording() {
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      
      mediaRecorder = null;
      audioChunks = [];
      isRecording = false;
      
      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }
    }
    
    function updateRecordingTimer() {
      if (!recordingStartTime) return;
      
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      document.getElementById('recordingTime').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // --- Insertar PDF corregido ---
    function insertPDF() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/pdf';
      input.onchange = e => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = async evt => {
            try {
              const arrayBuffer = evt.target.result;
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

              pdfCount++;
              const id = `pdf-${pdfCount}`;
              const pdfContainer = document.createElement("div");
              pdfContainer.className = "pdf-container";
              pdfContainer.id = id;

              const controls = document.createElement("div");
              controls.className = "pdf-controls";
              
              const zoomInBtn = document.createElement("button");
              zoomInBtn.textContent = "+";
              const zoomOutBtn = document.createElement("button");
              zoomOutBtn.textContent = "‚Äì";
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "Eliminar PDF";
              
              controls.appendChild(zoomInBtn);
              controls.appendChild(zoomOutBtn);
              controls.appendChild(deleteBtn);
              pdfContainer.appendChild(controls);

              let zoom = 1.0;

              zoomInBtn.onclick = () => {
                zoom += 0.2;
                pdfContainer.querySelectorAll("img").forEach(img => {
                  img.style.transform = `scale(${zoom})`;
                });
              };
              
              zoomOutBtn.onclick = () => {
                zoom = Math.max(0.1, zoom - 0.2);
                pdfContainer.querySelectorAll("img").forEach(img => {
                  img.style.transform = `scale(${zoom})`;
                });
              };
              
              deleteBtn.onclick = () => {
                pdfContainer.remove();
              };

              document.getElementById("editor").appendChild(pdfContainer);
              indexItems.push({ id: id, name: file.name });

              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ 
                  canvasContext: context, 
                  viewport: viewport 
                }).promise;

                const img = document.createElement("img");
                img.src = canvas.toDataURL("image/png");
                img.style.transform = `scale(${zoom})`;
                img.style.transformOrigin = "left top";
                img.style.display = "block";
                img.style.margin = "10px 0";
                img.style.maxWidth = "100%";
                pdfContainer.appendChild(img);

                const pageNum = document.createElement("div");
                pageNum.className = "page-number";
                pageNum.textContent = `P√°gina ${i}`;
                pdfContainer.appendChild(pageNum);
              }
            } catch (err) {
              alert("Error al cargar el PDF: " + err.message);
            }
          };
          reader.readAsArrayBuffer(file);
        });
      };
      input.click();
    }

    // --- Guardar / cargar ---
    function saveFile() {
      const content = document.getElementById('editor').innerHTML;
      const blob = new Blob([content], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'proyecto.wpage';
      a.click();
    }
    
    function loadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.wpage';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = evt => {
          document.getElementById('editor').innerHTML = evt.target.result;
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // --- Descargar HTML (con audio embebido) ---
    function downloadHTML() {
      const editor = document.getElementById('editor');
      const audios = editor.querySelectorAll("audio");

      const promises = Array.from(audios).map(audio => {
        const src = audio.getAttribute("src");
        if (src && src.startsWith("blob:")) {
          return fetch(src).then(r => r.blob()).then(blob => {
            return new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = () => {
                audio.setAttribute("src", reader.result);
                resolve();
              };
              reader.readAsDataURL(blob);
            });
          });
        }
        return Promise.resolve();
      });

      Promise.all(promises).then(() => {
        const content = editor.innerHTML;
        const bgColor = document.getElementById('bgColor').value;
        const pageTitle = document.getElementById('pageTitle').value.trim();
        const errorSpan = document.getElementById('titleError');
        
        if (!pageTitle) {
          errorSpan.textContent = "‚ö†Ô∏è Debes escribir un t√≠tulo antes de descargar.";
          document.getElementById('pageTitle').focus();
          return;
        } else {
          errorSpan.textContent = "";
        }

        let indexHTML = "<h2>√çndice</h2><ul>";
        indexItems.forEach(item => {
          indexHTML += `<li><a href="#${item.id}">${item.name}</a></li>`;
        });
        indexHTML += "</ul>";

        const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${pageTitle}</title>
  <style>
    body {
      background-color: ${bgColor}; 
      font-family: Arial, sans-serif; 
      margin: 10px; 
      padding: 10px;
    } 
    ul { list-style: square; } 
    .pdf-container, .image-container, .audio-block {
      border: 1px solid #ccc; 
      margin: 10px 0; 
      padding: 10px; 
      background: #fafafa; 
      border-radius: 6px;
    } 
    img { max-width: 100%; } 
    audio { width: 100%; }
  </style>
</head>
<body>
  ${indexHTML}
  ${content}
</body>
</html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = pageTitle.replace(/\s+/g, "_").toLowerCase() + '.html';
        a.click();
      });
    }
    
    // Cerrar submen√∫s al hacer clic fuera de ellos
    document.addEventListener('click', function(event) {
      if (activeSubmenu && !event.target.closest('.mobile-submenu') && !event.target.closest('.mobile-menu button')) {
        activeSubmenu.classList.remove('active');
        activeSubmenu = null;
      }
    });

    // Inicializar el editor con foco
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('editor').focus();
    });
  </script>
</body>
</html>