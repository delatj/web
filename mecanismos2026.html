<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenamiento Mecanismos - Precisión Educativa</title>
    <style>
        :root {
            --bg-page: #408080;
            --container-bg: #ffffff;
            --primary: #2c3e50;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-page);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
        }
        #score-banner {
            width: 100%; padding: 15px; background-color: #333; color: white;
            text-align: center; font-size: 1.5rem; font-weight: bold;
            position: sticky; top: 0; z-index: 1000; transition: background-color 0.5s ease;
        }
        .container {
            background-color: var(--container-bg);
            width: 95%; max-width: 600px; margin: 15px auto; padding: 20px;
            border-radius: 12px; border: 2px solid #000;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.2); text-align: center;
        }
        .canvas-area {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            margin: 15px 0; width: 100%; min-height: 180px;
            display: flex; justify-content: center; align-items: center;
        }
        svg { max-width: 100%; height: auto; }
        .problem-text {
            text-align: left; font-size: 1.05rem; background: #f4f4f4;
            padding: 15px; border-left: 5px solid var(--bg-page); margin-bottom: 15px;
        }
        .input-group { margin: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        label { font-weight: bold; font-size: 0.9rem; color: #444; }
        input[type="number"] {
            padding: 12px; width: 100%; max-width: 220px; border: 2px solid #333;
            border-radius: 6px; font-size: 1.1rem; text-align: center;
        }
        .btn {
            cursor: pointer; padding: 15px; width: 100%; margin: 5px 0;
            border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; text-transform: uppercase;
        }
        .btn-check { background-color: var(--primary); color: white; }
        #feedback { display: none; padding: 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
        #explanation {
            display: none; text-align: left; background: #fff9e6;
            padding: 20px; border-radius: 8px; margin-top: 10px;
            font-size: 0.95rem; border: 1px solid #ffeeba; line-height: 1.6;
        }
    </style>
</head>
<body>

<div id="score-banner">ACIERTOS: <span id="points">0</span></div>

<div class="container">
    <h3 id="mech-title">Cargando...</h3>
    <div class="canvas-area" id="drawing"></div>
    <div class="problem-text" id="desc"></div>
    <div id="inputs-container"></div>
    <button class="btn btn-check" onclick="verify()">Comprobar Resultado</button>
    <button class="btn" style="background:#eee; color:#333;" onclick="showHelp()">Ver Paso a Paso</button>
    <div id="feedback"></div>
    <div id="explanation"></div>
</div>

<script>
    let current = {};
    let score = 0;
    let sequenceIndex = 0;
    const types = ['PALANCA', 'POLEA', 'ENGRANAJE'];

    function init(repeat = false) {
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('explanation').style.display = 'none';
        
        // Alternar tipo de ejercicio solo si se ha acertado
        if (!repeat && score > 0) sequenceIndex = (sequenceIndex + 1) % 3;
        
        const type = types[sequenceIndex];
        if(type === 'PALANCA') genPalanca();
        else if(type === 'POLEA') genTrans('POLEA');
        else genTrans('ENGRANAJE');
        
        updateUI();
    }

    function genPalanca() {
        let d1 = Math.floor(Math.random() * 4) + 2;
        let d2 = Math.floor(Math.random() * 4) + 2;
        let F = (Math.floor(Math.random() * 8) + 1) * d1; 
        let R = (F * d2) / d1;

        const vars = ['F', 'd2', 'R', 'd1'];
        const vals = [F, d2, R, d1];
        const missing = Math.floor(Math.random() * 4);

        current = { type: 'PALANCA', target: vars[missing], ans: vals[missing] };
        document.getElementById('mech-title').innerText = "MECANISMO: PALANCA";
        document.getElementById('drawing').innerHTML = `
            <svg width="320" height="150" viewBox="0 0 320 150">
                <line x1="30" y1="90" x2="290" y2="90" stroke="#333" stroke-width="6"/>
                <polygon points="160,90 175,130 145,130" fill="#7f8c8d"/>
                <path d="M50,20 L50,80" stroke="red" stroke-width="4" marker-end="url(#arrR)"/>
                <text x="45" y="15" font-weight="bold" fill="red">F</text>
                <text x="95" y="110" font-size="14" fill="#555">d2</text>
                <path d="M270,20 L270,80" stroke="blue" stroke-width="4" marker-end="url(#arrB)"/>
                <text x="265" y="15" font-weight="bold" fill="blue">R</text>
                <text x="215" y="110" font-size="14" fill="#555">d1</text>
                <defs>
                    <marker id="arrR" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="red"/></marker>
                    <marker id="arrB" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="blue"/></marker>
                </defs>
            </svg>`;
        
        renderProblem(vars, vals, missing, " N", " m");
    }

    function genTrans(mode) {
        const isE = mode === 'ENGRANAJE';
        let v2 = Math.floor(Math.random() * 4) + 2; 
        let n1 = (Math.floor(Math.random() * 5) + 1) * 20;
        let v1 = v2 * (Math.floor(Math.random() * 3) + 1);
        let n2 = (v1 * n1) / v2;
        let rt = v1 / v2;

        const vars = [isE?'Z1':'D1', 'rpm1', isE?'Z2':'D2', 'rpm2'];
        const vals = [v1, n1, v2, n2];
        const missing = Math.floor(Math.random() * 4);

        current = { type: mode, target: vars[missing], ans: vals[missing], rt: rt };
        document.getElementById('mech-title').innerText = "MECANISMO: " + mode;
        
        if(isE) {
            document.getElementById('drawing').innerHTML = `
            <svg width="250" height="120">
                <circle cx="80" cy="60" r="30" fill="none" stroke="#2c3e50" stroke-width="2" stroke-dasharray="5,3"/>
                <circle cx="160" cy="60" r="45" fill="none" stroke="#2c3e50" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="70" y="65" font-weight="bold">Z1</text><text x="150" y="65" font-weight="bold">Z2</text>
            </svg>`;
            renderProblem(vars, vals, missing, " dientes", " rpm");
        } else {
            document.getElementById('drawing').innerHTML = `
            <svg width="250" height="120">
                <circle cx="70" cy="60" r="25" stroke="black" fill="none" stroke-width="3"/>
                <circle cx="180" cy="60" r="42" stroke="black" fill="none" stroke-width="3"/>
                <line x1="70" y1="35" x2="180" y2="18" stroke="#666" stroke-width="2"/>
                <line x1="70" y1="85" x2="180" y2="102" stroke="#666" stroke-width="2"/>
                <text x="60" y="65" font-weight="bold">D1</text><text x="170" y="65" font-weight="bold">D2</text>
            </svg>`;
            renderProblem(vars, vals, missing, " cm", " rpm");
        }
    }

    function renderProblem(vars, vals, missing, u1, u2) {
        let txt = "<strong>DATOS DEL PROBLEMA:</strong><br><br>";
        vars.forEach((v, i) => {
            if(i !== missing) {
                let unit = v.includes('d') || v.includes('Z') || v.includes('D') ? u1 : u2;
                txt += `<b>${v}:</b> ${vals[i]}${unit}<br>`;
            }
        });
        txt += `<br>Encuentra el valor exacto de: <b>${vars[missing]}</b>`;
        document.getElementById('desc').innerHTML = txt;

        let h = `<div class="input-group"><label>Escribe el valor de ${current.target}:</label><input type="number" id="ans1"></div>`;
        if(current.type !== 'PALANCA') {
            h += `<div class="input-group"><label>Relación de Transmisión (R.T.):</label><input type="number" id="ans2"></div>`;
        }
        document.getElementById('inputs-container').innerHTML = h;
    }

    function verify() {
        const u1 = parseInt(document.getElementById('ans1').value);
        let ok = (u1 === current.ans);
        if(current.type !== 'PALANCA') {
            const u2 = parseFloat(document.getElementById('ans2').value);
            ok = ok && (u2 === current.rt);
        }

        const fb = document.getElementById('feedback');
        fb.style.display = 'block';

        if(ok) {
            score++;
            fb.style.background = "#d4edda"; fb.style.color = "#155724";
            fb.innerText = "¡RESPUESTA CORRECTA! Sigue así.";
            setTimeout(() => init(false), 1500);
        } else {
            fb.style.background = "#f8d7da"; fb.style.color = "#721c24";
            fb.innerText = `RESPUESTA INCORRECTA. El valor era ${current.ans}. Inténtalo de nuevo con otro ejercicio.`;
            setTimeout(() => init(true), 3000);
        }
    }

    function updateUI() {
        document.getElementById('points').innerText = score;
        const banner = document.getElementById('score-banner');
        if(score <= 5) banner.style.backgroundColor = "#3498db";
        else if(score <= 10) banner.style.backgroundColor = "#27ae60";
        else if(score <= 15) banner.style.backgroundColor = "#f1c40f";
        else if(score <= 20) banner.style.backgroundColor = "#e67e22";
        else banner.style.backgroundColor = "#e74c3c";
    }

    function showHelp() {
        const d = document.getElementById('explanation');
        d.style.display = 'block';
        if(current.type === 'PALANCA') {
            d.innerHTML = `<strong>PASO A PASO - PALANCA:</strong><br>
            1. Anota la ley fundamental: <b>R \u00B7 d1 = F \u00B7 d2</b>.<br>
            2. Sustituye los valores que ya conoces.<br>
            3. Multiplica los dos números que están juntos en el mismo lado de la igualdad.<br>
            4. El resultado divídelo por el número que acompaña a la letra que te falta.<br>
            5. El resultado siempre será un número entero.`;
        } else {
            const f = current.type === 'POLEA' ? 'D1 \u00B7 rpm1 = D2 \u00B7 rpm2' : 'Z1 \u00B7 rpm1 = Z2 \u00B7 rpm2';
            const r = current.type === 'POLEA' ? 'R.T. = D1 / D2' : 'R.T. = Z1 / Z2';
            d.innerHTML = `<strong>PASO A PASO - TRANSMISIÓN:</strong><br>
            1. Aplica la fórmula de velocidades: <b>${f}</b>.<br>
            2. Multiplica el tamaño (D o Z) por su velocidad (<b>rpm1</b> o <b>rpm2</b>) en el eje que tengas completo.<br>
            3. Divide el resultado entre el dato conocido del otro eje.<br>
            4. <b>Cálculo de la R.T.:</b> Divide el tamaño o velocidad del eje 1 entre el eje 2: <b>${r}</b>.`;
        }
    }

    window.onload = () => init();
</script>
</body>
</html>