<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visualizador de Excel</title>

  <!-- XLSX: CDN + fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
          onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';document.head.appendChild(s);}())">
  </script>

  <style>
    :root{
      --c-primary:#4b6a88;
      --c-primary-dark:#3a526b;
      --c-border:#ddd;
      --c-bg:#f5f5f5;
      --c-card:#fff;
    }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif; margin:20px; background:var(--c-bg); color:#333}
    .container{max-width:1200px; margin:0 auto; background:#fff; padding:20px; border-radius:8px;
      box-shadow:0 4px 16px rgba(0,0,0,.08)}
    h1{text-align:center; margin:0 0 10px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom:16px}
    button{background:var(--c-primary); color:#fff; border:0; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:14px}
    button:hover{background:var(--c-primary-dark)}
    button:disabled{background:#bbb; cursor:not-allowed}
    #fileInput{display:none}
    .file-input-label{display:inline-block; padding:10px 14px; background:var(--c-primary); color:#fff; border-radius:6px; cursor:pointer}
    .file-input-label:hover{background:var(--c-primary-dark)}

    /* tabla principal */
    #tableContainer{overflow:auto; border:1px solid var(--c-border); border-radius:6px}
    table{width:100%; border-collapse:collapse; font-size:12px}
    th,td{border:1px solid var(--c-border); padding:6px; text-align:left}
    th{background:var(--c-primary); color:#fff; position:sticky; top:0; z-index:1}

    /* estados */
    .status{margin-top:12px; padding:10px; border-radius:6px; display:none}
    .success{background:#dff0d8; color:#3c763d; border:1px solid #d6e9c6}
    .error{background:#f2dede; color:#a94442; border:1px solid #ebccd1}

    /* búsqueda */
    #searchContainer{display:none; margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    #searchInput{padding:8px 10px; border:1px solid var(--c-border); border-radius:6px; min-width:260px}

    /* resultados como tarjetas */
    #resultContainer{display:none; margin-top:18px}
    #resultCards .card{border:1px solid var(--c-border); border-radius:10px; padding:12px; margin-bottom:14px; background:var(--c-card);
      box-shadow:0 2px 6px rgba(0,0,0,.08)}
    #resultCards .card h3{margin:0 0 8px; font-size:16px}
    .row-line{padding:6px}
    .row-line:nth-child(even){background:#f9f9f9}

    /* Colores por grupos */
    .group-L{background:#e6f0ff}   /* azul claro */
    .group-M{background:#fff0e6}   /* naranja claro */
    .group-X{background:#e6ffe6}   /* verde claro */
    .group-J{background:#ffe6f0}   /* rosa claro */
    .group-V{background:#ffffcc}   /* amarillo claro */
    .group-Other{background:#f5f5f5}

    #backButton{margin-top:8px}

    /* móvil */
    @media (max-width:600px){
      .controls{gap:8px}
      table{font-size:11px}
      .file-input-label, button{width:100%}
      #searchInput{flex:1}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visualizador de Archivos Excel</h1>

    <div class="controls">
      <label for="fileInput" class="file-input-label" id="pickFileBtn">Seleccionar Archivo Excel</label>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm,.csv" />
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button id="searchBtn" disabled>Buscar Registro</button>
        <button id="exportHtmlBtn" disabled>Descargar HTML</button>
      </div>
    </div>

    <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Buscar por la primera columna (ej. tec)" />
      <button id="searchButton">Buscar</button>
    </div>

    <div id="status" class="status"></div>

    <div id="tableContainer">
      <table id="dataTable">
        <thead><tr id="tableHeader"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="resultContainer">
      <h2 style="margin:12px 0 8px">Detalle de los Registros</h2>
      <div id="resultCards"></div>
      <button id="backButton">Volver a la tabla principal</button>
    </div>
  </div>

  <script>
    var workbookData = null; // Array de arrays
    var headers = [];

    var fileInput = document.getElementById('fileInput');
    var pickFileBtn = document.getElementById('pickFileBtn');
    var searchBtn = document.getElementById('searchBtn');
    var exportHtmlBtn = document.getElementById('exportHtmlBtn');
    var tableHeader = document.getElementById('tableHeader');
    var tableBody = document.getElementById('tableBody');
    var statusDiv = document.getElementById('status');
    var searchContainer = document.getElementById('searchContainer');
    var searchInput = document.getElementById('searchInput');
    var searchButton = document.getElementById('searchButton');
    var resultContainer = document.getElementById('resultContainer');
    var resultCards = document.getElementById('resultCards');
    var backButton = document.getElementById('backButton');
    var tableContainer = document.getElementById('tableContainer');

    // Asegurar apertura del selector de archivos en todos los navegadores
    pickFileBtn.addEventListener('click', function(){
      fileInput.click();
    });

    fileInput.addEventListener('change', handleFileSelect);
    searchBtn.addEventListener('click', function(){
      searchContainer.style.display = 'flex';
      searchInput.focus();
    });
    searchButton.addEventListener('click', searchRecord);
    backButton.addEventListener('click', backToMainTable);
    exportHtmlBtn.addEventListener('click', exportToHtml);

    function showStatus(msg, type){
      statusDiv.textContent = msg;
      statusDiv.className = 'status ' + type;
      statusDiv.style.display = 'block';
      clearTimeout(window.__sts);
      window.__sts = setTimeout(function(){ statusDiv.style.display='none'; }, 4500);
    }

    function ensureXLSXReady(){
      if (!window.XLSX){
        showStatus('No se pudo cargar la librería XLSX. Revisa tu conexión a internet.', 'error');
        return false;
      }
      return true;
    }

    function handleFileSelect(evt){
      try{
        if (!ensureXLSXReady()) return;
        var f = fileInput.files && fileInput.files[0];
        if (!f){ showStatus('No se seleccionó archivo', 'error'); return; }

        var reader = new FileReader();
        reader.onload = function(e){
          try{
            var data = new Uint8Array(e.target.result);
            var wb = XLSX.read(data, { type: 'array' });
            var firstName = wb.SheetNames && wb.SheetNames.length ? wb.SheetNames[0] : null;
            if (!firstName){ showStatus('El archivo no tiene hojas', 'error'); return; }
            var ws = wb.Sheets[firstName];
            var arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            if (!arr || !arr.length){
              showStatus('La hoja está vacía', 'error');
              return;
            }
            workbookData = arr;
            displayDataInTable(workbookData);
            searchBtn.disabled = false;
            exportHtmlBtn.disabled = false;
            showStatus('Archivo cargado correctamente', 'success');
          }catch(err){
            console.error(err);
            showStatus('Error leyendo el archivo: ' + (err && err.message ? err.message : 'desconocido'), 'error');
          }
        };
        // ArrayBuffer funciona para xlsx/xls/xlsm/csv
        reader.readAsArrayBuffer(f);
      }catch(err){
        console.error(err);
        showStatus('No se pudo procesar el archivo: ' + (err && err.message ? err.message : 'desconocido'), 'error');
      }
    }

    function displayDataInTable(data){
      tableHeader.innerHTML = '';
      tableBody.innerHTML = '';
      if (!data || !data.length) return;

      headers = data[0];
      for (var h = 0; h < headers.length; h++){
        var th = document.createElement('th');
        th.textContent = headers[h] ? String(headers[h]) : '';
        tableHeader.appendChild(th);
      }

      for (var i = 1; i < data.length; i++){
        var tr = document.createElement('tr');
        for (var j = 0; j < headers.length; j++){
          var td = document.createElement('td');
          var cell = (data[i] && typeof data[i][j] !== 'undefined' && data[i][j] !== null) ? data[i][j] : '';
          td.textContent = cell;
          tr.appendChild(td);
        }
        tableBody.appendChild(tr);
      }
    }

    function searchRecord(){
      if (!workbookData || !workbookData.length){
        showStatus('Primero carga un archivo', 'error');
        return;
      }
      var value = (searchInput.value || '').trim().toLowerCase();
      if (!value){
        showStatus('Ingrese un valor para buscar', 'error');
        return;
      }
      var results = [];
      for (var i = 1; i < workbookData.length; i++){
        var firstCell = workbookData[i] && typeof workbookData[i][0] !== 'undefined' && workbookData[i][0] !== null
                        ? String(workbookData[i][0]).toLowerCase() : '';
        if (firstCell.indexOf(value) !== -1) results.push(workbookData[i]);
      }
      if (results.length){
        displayResults(results);
        showStatus('Se encontraron ' + results.length + ' registros', 'success');
      } else {
        showStatus('No se encontró ningún registro', 'error');
      }
    }

    function getGroupClass(h){
      h = h || '';
      h = String(h);
      if (h.charAt(0) === 'L') return 'group-L';
      if (h.charAt(0) === 'M') return 'group-M';
      if (h.charAt(0) === 'X') return 'group-X';
      if (h.charAt(0) === 'J') return 'group-J';
      if (h.charAt(0) === 'V') return 'group-V';
      return 'group-Other';
    }

    function displayResults(rows){
      tableContainer.style.display = 'none';
      searchContainer.style.display = 'none';
      resultContainer.style.display = 'block';
      resultCards.innerHTML = '';

      for (var r = 0; r < rows.length; r++){
        var row = rows[r];
        var card = '<div class="card"><h3>Registro ' + (r+1) + '</h3>';
        for (var i = 0; i < headers.length; i++){
          var h = headers[i];
          var v = (typeof row[i] !== 'undefined' && row[i] !== null) ? row[i] : '';
          var groupClass = getGroupClass(h);
          var label = h ? h : ('Columna ' + (i+1));
          card += '<div class="row-line ' + groupClass + '"><strong>' + label + ':</strong> ' + v + '</div>';
        }
        card += '</div>';
        resultCards.innerHTML += card;
      }
    }

    function backToMainTable(){
      tableContainer.style.display = 'block';
      resultContainer.style.display = 'none';
      searchContainer.style.display = 'none';
      searchInput.value = '';
    }

    // Exporta HTML autónomo con la misma interfaz
    function exportToHtml(){
      if (!workbookData || !workbookData.length) return;

      var html = '<!DOCTYPE html><html lang="es"><head>' +
      '<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">' +
      '<title>Datos Exportados</title>' +
      '<style>' +
      'body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;color:#333}' +
      'h1{text-align:center;margin:0 0 10px}' +
      '#controls{text-align:center;margin-bottom:15px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}' +
      'input,button{padding:8px 12px;border-radius:6px;border:1px solid #ccc}' +
      'button{background:#4b6a88;color:#fff;border:0} button:hover{background:#3a526b}' +
      '.card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08)}' +
      '.card h3{margin:0 0 8px;font-size:16px}' +
      '.row-line{padding:6px}' +
      '.row-line:nth-child(even){background:#f9f9f9}' +
      '.group-L{background:#e6f0ff}.group-M{background:#fff0e6}.group-X{background:#e6ffe6}.group-J{background:#ffe6f0}.group-V{background:#ffffcc}.group-Other{background:#f5f5f5}' +
      '@media(max-width:600px){input,button{width:100%}}' +
      '</style></head><body>' +
      '<h1>Datos Exportados</h1>' +
      '<div id="controls">' +
      '<input type="text" id="searchInput" placeholder="Buscar en la primera columna">' +
      '<button onclick="buscar()">Buscar</button>' +
      '<button onclick="restaurar()">Restablecer</button>' +
      '</div><div id="results"></div>' +
      '<script>' +
      'var rows=' + JSON.stringify(workbookData) + ';' +
      'var headers=' + JSON.stringify(headers) + ';' +
      'function getGroupClass(h){h=h||"";h=String(h);if(h.charAt(0)==="L")return"'+ "group-L" +'";if(h.charAt(0)==="M")return"'+ "group-M" +'";if(h.charAt(0)==="X")return"'+ "group-X" +'";if(h.charAt(0)==="J")return"'+ "group-J" +'";if(h.charAt(0)==="V")return"'+ "group-V" +'";return"'+ "group-Other" +'"}' +
      'function mostrar(rs){var out="";for(var r=0;r<rs.length;r++){var row=rs[r];out+=\'<div class="card"><h3>Registro ' + "' + (r+1) + '" + '</h3>\';for(var i=0;i<headers.length;i++){var h=headers[i];var v=(typeof row[i]!== "undefined" && row[i]!==null)?row[i]:"";var label=h?h:("Columna "+(i+1));var gc=getGroupClass(h);out+=\'<div class="row-line '+ "' + gc + '" +'"><strong>\'+label+\':</strong> \'+v+\'</div>\';}out+=\'</div>\';}document.getElementById("results").innerHTML=out;}' +
      'function buscar(){var val=(document.getElementById("searchInput").value||"").toLowerCase();var f=[];for(var i=1;i<rows.length;i++){var c=(rows[i]&&typeof rows[i][0]!=="undefined"&&rows[i][0]!==null)?String(rows[i][0]).toLowerCase():"";if(c.indexOf(val)!==-1)f.push(rows[i]);}mostrar(f);}' +
      'function restaurar(){mostrar(rows.slice(1));document.getElementById("searchInput").value="";}' +
      'restaurar();' +
      '<\/script></body></html>';

      var blob = new Blob([html], {type:'text/html'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'datos_exportados.html';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
