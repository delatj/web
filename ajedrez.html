<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ajedrez Pro - Versión Final Corregida</title>
    <style>
        :root {
            --primary: #2ecc71; --dark: #1a1a1a; --panel: #2c3e50;
            --light-sq: #dee3e6; --dark-sq: #8ca2ad; 
            --highlight: rgba(241, 196, 15, 0.7);
            --legal: rgba(46, 204, 113, 0.4);
            --danger: #e74c3c;
        }
        body { background: var(--dark); color: white; margin: 0; font-family: 'Arial Black', Gadget, sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR Y PUNTUACIÓN GIGANTE */
        .sidebar { width: 320px; background: var(--panel); padding: 20px; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.5); }
        #turn-box { font-size: 1.4rem; font-weight: bold; text-align: center; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--primary); }
        
        .score-container { text-align: center; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; }
        .score-label { font-size: 1.2rem; color: #bdc3c7; }
        .score-num { font-size: 5rem; font-weight: 900; line-height: 1; margin: 10px 0 30px 0; display: block; color: var(--primary); text-shadow: 2px 2px 0px #000; }

        /* TABLERO */
        .game-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #34495e, #1a1a1a); }
        #board { display: grid; grid-template-columns: repeat(8, 75px); grid-template-rows: repeat(8, 75px); border: 8px solid #333; }
        .square { width: 75px; height: 75px; display: flex; justify-content: center; align-items: center; font-size: 55px; cursor: pointer; user-select: none; }
        .white-sq { background-color: var(--light-sq); }
        .black-sq { background-color: var(--dark-sq); }
        
        /* ESTILO DE PIEZAS */
        .piece { position: relative; z-index: 10; }
        .piece.white { color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .piece.black { color: #222222; text-shadow: 0 0 10px rgba(255,255,255,0.8), 1px 1px 0 #fff; }

        .selected { background-color: var(--highlight) !important; }
        .legal-dot::after { content: ''; width: 18px; height: 18px; background: var(--legal); border-radius: 50%; }

        /* MODAL CORONACIÓN */
        #promotion-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #promotion-box { background: var(--panel); padding: 30px; border-radius: 20px; border: 4px solid var(--primary); text-align: center; }
        .promo-btn { width: 90px; height: 90px; font-size: 60px; margin: 10px; cursor: pointer; border-radius: 15px; border: none; background: #eee; transition: 0.2s; }
        .promo-btn:hover { background: var(--primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>

<div class="sidebar">
    <div id="turn-box">TURNO: BLANCAS</div>
    <div class="score-container">
        <span class="score-label">BLANCAS</span>
        <span id="w-score" class="score-num">0</span>
        <span class="score-label">NEGRAS</span>
        <span id="b-score" class="score-num">0</span>
    </div>
    <button onclick="location.reload()" style="background:var(--danger); color:white; border:none; padding:15px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:20px;">REINICIAR PARTIDA</button>
</div>

<div class="game-container">
    <div id="board"></div>
</div>

<div id="promotion-overlay">
    <div id="promotion-box">
        <h2 style="margin-top:0">¡PEÓN CORONADO!</h2>
        <p>Elige tu nueva pieza:</p>
        <div id="promo-options"></div>
    </div>
</div>

<script>
    const symbols = { 'r':'♜','n':'♞','b':'♝','q':'♛','k':'♚','p':'♟','R':'♖','N':'♘','B':'♗','Q':'♕','K':'♔','P':'♙' };
    let board = [
        ['r','n','b','q','k','b','n','r'],
        ['p','p','p','p','p','p','p','p'],
        ['.','.','.','.','.','.','.','.'],
        ['.','.','.','.','.','.','.','.'],
        ['.','.','.','.','.','.','.','.'],
        ['.','.','.','.','.','.','.','.'],
        ['P','P','P','P','P','P','P','P'],
        ['R','N','B','Q','K','B','N','R']
    ];

    let turn = 'white', selected = null, isGameOver = false, scores = { white:0, black:0 };
    let moved = { K:false, k:false, R0:false, R7:false, r0:false, r7:false };
    let promotionData = null;

    function renderBoard() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        for (let r=0; r<8; r++) {
            for (let c=0; c<8; c++) {
                const sq = document.createElement('div');
                sq.className = `square ${(r+c)%2===0?'white-sq':'black-sq'}`;
                
                const p = board[r][c];
                if(p !== '.') {
                    const span = document.createElement('span');
                    span.innerText = symbols[p];
                    span.className = `piece ${p === p.toUpperCase() ? 'white' : 'black'}`;
                    sq.appendChild(span);
                }

                if(selected && selected.r === r && selected.c === c) sq.classList.add('selected');
                
                if(selected) {
                    const moves = getSafeMoves(selected.r, selected.c);
                    if(moves.some(m => m.r === r && m.c === c)) sq.classList.add('legal-dot');
                }

                sq.onclick = () => handleClick(r, c);
                boardEl.appendChild(sq);
            }
        }
    }

    function handleClick(r, c) {
        if(isGameOver || promotionData) return;
        const piece = board[r][c];
        const color = piece === '.' ? null : (piece === piece.toUpperCase() ? 'white' : 'black');

        if(selected) {
            const moves = getSafeMoves(selected.r, selected.c);
            const move = moves.find(m => m.r === r && m.c === c);
            if(move) {
                executeMove(selected.r, selected.c, r, c, move.castle);
                return;
            }
        }
        if(color === turn) selected = {r, c};
        else selected = null;
        renderBoard();
    }

    function executeMove(fR, fC, tR, tC, castleSide) {
        const piece = board[fR][fC];
        const target = board[tR][tC];

        // Puntos
        if(target !== '.') {
            const vals = {p:1, n:3, b:3, r:5, q:9, k:0};
            scores[turn] += vals[target.toLowerCase()];
        }

        // Lógica de Enroque
        if(castleSide) {
            if(castleSide === 'king') {
                board[tR][tC-1] = board[tR][7]; board[tR][7] = '.';
            } else {
                board[tR][tC+1] = board[tR][0]; board[tR][0] = '.';
            }
        }

        // Mover pieza
        board[tR][tC] = piece;
        board[fR][fC] = '.';

        // Rastrear movimientos para enroque futuro
        if(piece === 'K') moved.K = true;
        if(piece === 'k') moved.k = true;
        if(fR===7 && fC===0) moved.R0 = true;
        if(fR===7 && fC===7) moved.R7 = true;
        if(fR===0 && fC===0) moved.r0 = true;
        if(fR===0 && fC===7) moved.r7 = true;

        // Coronación
        if((piece === 'P' && tR === 0) || (piece === 'p' && tR === 7)) {
            showPromo(tR, tC);
            return;
        }

        finalizeMove();
    }

    function finalizeMove() {
        turn = turn === 'white' ? 'black' : 'white';
        selected = null;
        document.getElementById('w-score').innerText = scores.white;
        document.getElementById('b-score').innerText = scores.black;
        document.getElementById('turn-box').innerText = `TURNO: ${turn.toUpperCase()}`;
        renderBoard();
    }

    function getSafeMoves(r, c) {
        const p = board[r][c].toLowerCase();
        const isW = board[r][c] === board[r][c].toUpperCase();
        let moves = [];
        
        // Direcciones
        if(p === 'p') {
            let d = isW ? -1 : 1;
            if(isValid(r+d, c) && board[r+d][c] === '.') moves.push({r:r+d, c});
            if((isW && r===6 || !isW && r===1) && board[r+d][c]==='.' && board[r+2*d][c]==='.') moves.push({r:r+2*d, c});
            [[d,1],[d,-1]].forEach(off => {
                if(isValid(r+off[0], c+off[1]) && board[r+off[0]][c+off[1]] !== '.' && getCol(r+off[0], c+off[1]) !== turn)
                    moves.push({r:r+off[0], c:c+off[1]});
            });
        }
        if(p === 'n') {
            [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(d => {
                if(isValid(r+d[0], c+d[1]) && getCol(r+d[0], c+d[1]) !== turn) moves.push({r:r+d[0], c:c+d[1]});
            });
        }
        if(['r','b','q'].includes(p)) {
            let ds = [];
            if(p==='r'||p==='q') ds.push([1,0],[-1,0],[0,1],[0,-1]);
            if(p==='b'||p==='q') ds.push([1,1],[1,-1],[-1,1],[-1,-1]);
            ds.forEach(d => {
                for(let i=1; i<8; i++) {
                    let nr=r+d[0]*i, nc=c+d[1]*i;
                    if(!isValid(nr,nc)) break;
                    if(board[nr][nc] === '.') moves.push({r:nr, c:nc});
                    else { if(getCol(nr,nc) !== turn) moves.push({r:nr, c:nc}); break; }
                }
            });
        }
        if(p === 'k') {
            for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++) {
                if(dr===0 && dc===0) continue;
                if(isValid(r+dr, c+dc) && getCol(r+dr, c+dc) !== turn) moves.push({r:r+dr, c:c+dc});
            }
            // Lógica Enroque
            if(isW && !moved.K) {
                if(!moved.R7 && board[7][5]==='.' && board[7][6]==='.') moves.push({r:7, c:6, castle:'king'});
                if(!moved.R0 && board[7][1]==='.' && board[7][2]==='.' && board[7][3]==='.') moves.push({r:7, c:2, castle:'queen'});
            }
            if(!isW && !moved.k) {
                if(!moved.r7 && board[0][5]==='.' && board[0][6]==='.') moves.push({r:0, c:6, castle:'king'});
                if(!moved.r0 && board[0][1]==='.' && board[0][2]==='.' && board[0][3]==='.') moves.push({r:0, c:2, castle:'queen'});
            }
        }
        return moves;
    }

    function showPromo(r, c) {
        promotionData = {r, c};
        const overlay = document.getElementById('promotion-overlay');
        const box = document.getElementById('promo-options');
        box.innerHTML = '';
        const opts = turn === 'white' ? ['Q','R','B','N'] : ['q','r','b','n'];
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'promo-btn';
            btn.innerText = symbols[o];
            btn.onclick = () => {
                board[r][c] = o;
                overlay.style.display = 'none';
                promotionData = null;
                finalizeMove();
            };
            box.appendChild(btn);
        });
        overlay.style.display = 'flex';
    }

    function getCol(r, c) { const p = board[r][c]; return p==='.'?null:(p===p.toUpperCase()?'white':'black'); }
    function isValid(r, c) { return r>=0 && r<8 && c>=0 && c<8; }

    renderBoard();
</script>
</body>
</html>