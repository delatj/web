<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dibuja planos con cotas</title>
<style>
:root{--bg:#f6f7fb;--accent:#0b5fff;--muted:#666;--cota:#000000}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
.app{display:flex;flex-direction:column;height:100vh;padding:12px;gap:12px;background:var(--bg)}
.top{display:flex;gap:12px;align-items:center}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
label{font-size:14px;color:var(--muted)}
input[type=range]{width:140px}
select{padding:4px}
button{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
button.ghost{background:transparent;color:var(--muted);border:1px solid #ddd}
button.secondary{background:#444}
.canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;position:relative}
canvas{background:white;border-radius:8px;box-shadow:0 6px 18px rgba(10,10,20,0.08);max-width:100%;height:auto}
.help{font-size:13px;color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.footer{display:flex;justify-content:space-between;align-items:center}
.menuCota{position:absolute;background:white;border:1px solid #ccc;padding:6px;border-radius:6px;display:none;}
.menuCota button{margin:2px;padding:4px 8px;font-size:12px;}
</style>
</head>
<body>
<div class="app">
<div class="top">
<div style="font-weight:700;font-size:18px">Dibuja planos (con cotas)</div>
<div style="flex:1"></div>
<div class="controls">
<label>Columnas: <span id="colsLabel">20</span></label>
<input id="cols" type="range" min="8" max="48" value="20">
<label>Filas: <span id="rowsLabel">20</span></label>
<input id="rows" type="range" min="8" max="48" value="20">
<label>Tamaño punto: <span id="dotLabel">6</span>px</label>
<input id="dotSize" type="range" min="3" max="12" value="6">

<label>Escala:</label>
<select id="scaleSelect">
  <option value="0.5">0.5 cm</option>
  <option value="1" selected>1 cm</option>
  <option value="2">2 cm</option>
</select>

<button id="undo" class="ghost">Deshacer</button>
<button id="clear" class="ghost">Borrar todo</button>
<button id="toggleCota" class="secondary">Modo cota: OFF</button>
<button id="download">Descargar PDF</button>
</div>
</div>
<div class="canvas-wrap">
<canvas id="board" width="900" height="900" aria-label="Tablero de dibujo por puntos"></canvas>
<div id="menuCota" class="menuCota">
<button data-pos="arriba">Arriba</button>
<button data-pos="abajo">Abajo</button>
<button data-pos="izquierda">Izquierda</button>
<button data-pos="derecha">Derecha</button>
</div>
</div>
<div class="footer">
<div class="help">Modo cota: elige dos puntos alineados horizontal o vertical y selecciona la posición de la cota.</div>
<div class="small">Exporta en PDF a escala real.</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const menuCota = document.getElementById('menuCota');
let cols=20, rows=20, dotSize=6;
let points=[], lines=[], cotas=[];
let cotaMode=false, cotaFirst=null;
let lastIdx=null;
let unitCM;              
let scaleCM = 1;         // cm que mide cada cuadrito
const cotaOffset=50;     
const flechaSize=3;      

function fixDPI(){
  const ratio=window.devicePixelRatio||1;
  const w=canvas.width; const h=canvas.height;
  canvas.width=w*ratio; canvas.height=h*ratio;
  canvas.style.width=w+'px'; canvas.style.height=h+'px';
  ctx.setTransform(ratio,0,0,ratio,0,0);
}

function rebuildPoints(){
  points=[];
  const width=parseInt(canvas.style.width);
  const height=parseInt(canvas.style.height);
  const cellW=width/(cols-1);
  const cellH=height/(rows-1);

  // recalcular pixeles por cm (cada cuadrito = scaleCM cm)
  unitCM = cellW / scaleCM;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      points.push({x:Math.round(c*cellW), y:Math.round(r*cellH)});
    }
  }
}

function drawGrid(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // dibujar líneas de cuadrícula
  ctx.strokeStyle='#eee';
  ctx.lineWidth=1;
  const cellW = points[1].x - points[0].x;
  const cellH = points[cols].y - points[0].y;
  for(let r=0;r<rows;r++){
    ctx.beginPath();
    ctx.moveTo(points[r*cols].x, points[r*cols].y);
    ctx.lineTo(points[r*cols + (cols-1)].x, points[r*cols + (cols-1)].y);
    ctx.stroke();
  }
  for(let c=0;c<cols;c++){
    ctx.beginPath();
    ctx.moveTo(points[c].x, points[c].y);
    ctx.lineTo(points[(rows-1)*cols + c].x, points[(rows-1)*cols + c].y);
    ctx.stroke();
  }

  // dibujar líneas de usuario
  ctx.strokeStyle='#111'; ctx.lineWidth=2;
  lines.forEach(ln=>{
    const A=points[ln.a], B=points[ln.b];
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
  });

  // dibujar cotas
  cotas.forEach(ct=>drawCota(ctx,ct));

  // dibujar puntos
  points.forEach(p=>{
    ctx.beginPath();
    ctx.fillStyle='#0b5fff';
    ctx.arc(p.x,p.y,dotSize,0,Math.PI*2);
    ctx.fill();
  });
}

function nearestPoint(x,y){
  let best=null,bestDist=Infinity;
  points.forEach((p,i)=>{
    const d=(p.x-x)**2+(p.y-y)**2;
    if(d<bestDist){ bestDist=d; best=i; }
  });
  const width=parseInt(canvas.style.width), height=parseInt(canvas.style.height);
  const threshold=Math.max(width/(cols-1),height/(rows-1))*0.6;
  return bestDist<=threshold**2?best:null;
}

canvas.addEventListener('click',ev=>{
  const rect=canvas.getBoundingClientRect();
  const pos={x:ev.clientX-rect.left,y:ev.clientY-rect.top};
  const idx=nearestPoint(pos.x,pos.y);
  if(idx===null) return;
  if(cotaMode){
    if(cotaFirst===null){ cotaFirst=idx; }
    else{
      const p1=points[cotaFirst], p2=points[idx];
      if(p1.x===p2.x || p1.y===p2.y){
        menuCota.style.left=ev.clientX+'px';
        menuCota.style.top=ev.clientY+'px';
        menuCota.style.display='block';
        menuCota.dataset.a=cotaFirst; menuCota.dataset.b=idx;
      } else { alert('Seleccione puntos alineados horizontal o vertical'); cotaFirst=null; }
    }
  } else {
    if(lastIdx===null) lastIdx=idx;
    else if(idx!==lastIdx){ lines.push({a:lastIdx,b:idx}); lastIdx=idx; drawGrid(); }
  }
});

menuCota.querySelectorAll('button').forEach(b=>{
  b.addEventListener('click',()=>{
    const a=parseInt(menuCota.dataset.a), bIdx=parseInt(menuCota.dataset.b);
    cotas.push({a:a,b:bIdx,pos:b.dataset.pos});
    cotaFirst=null; menuCota.style.display='none'; drawGrid();
  });
});

function drawCota(ctx,ct){
  const A=points[ct.a], B=points[ct.b];
  ctx.strokeStyle='#000'; ctx.fillStyle='#000'; ctx.lineWidth=1.5; ctx.font='12px sans-serif';
  if(A.y===B.y){ // horizontal
    const y=ct.pos==='arriba'? A.y-cotaOffset : A.y+cotaOffset;
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(A.x,y); ctx.moveTo(B.x,B.y); ctx.lineTo(B.x,y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(A.x,y); ctx.lineTo(B.x,y); ctx.stroke();
    drawFlecha(ctx,A.x,y,'H',false); drawFlecha(ctx,B.x,y,'H',true);
    const dist=Math.abs(B.x-A.x)/unitCM;
    ctx.fillText((dist*scaleCM).toFixed(1)+' cm',(A.x+B.x)/2,y-2);
  } else { // vertical
    const x=ct.pos==='izquierda'? A.x-cotaOffset : A.x+cotaOffset;
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(x,A.y); ctx.moveTo(B.x,B.y); ctx.lineTo(x,B.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,A.y); ctx.lineTo(x,B.y); ctx.stroke();
    drawFlecha(ctx,x,A.y,'V',false); drawFlecha(ctx,x,B.y,'V',true);
    const dist=Math.abs(B.y-A.y)/unitCM;
    ctx.save(); ctx.translate(x-7,(A.y+B.y)/2); ctx.rotate(-Math.PI/2); ctx.fillText((dist*scaleCM).toFixed(1)+' cm',0,0); ctx.restore();
  }
}

function drawFlecha(ctx,x,y,dir,start){
  ctx.beginPath(); const size=flechaSize;
  if(dir==='H'){ if(start){ ctx.moveTo(x+size,y-size); ctx.lineTo(x,y); ctx.lineTo(x+size,y+size); } else { ctx.moveTo(x-size,y-size); ctx.lineTo(x,y); ctx.lineTo(x-size,y+size); } }
  else { if(start){ ctx.moveTo(x-size,y+size); ctx.lineTo(x,y); ctx.lineTo(x+size,y+size); } else { ctx.moveTo(x-size,y-size); ctx.lineTo(x,y); ctx.lineTo(x+size,y-size); } }
  ctx.stroke();
}

// controles
document.getElementById('cols').addEventListener('input',e=>{ cols=parseInt(e.target.value); document.getElementById('colsLabel').textContent=cols; rebuildPoints(); drawGrid(); });
document.getElementById('rows').addEventListener('input',e=>{ rows=parseInt(e.target.value); document.getElementById('rowsLabel').textContent=rows; rebuildPoints(); drawGrid(); });
document.getElementById('dotSize').addEventListener('input',e=>{ dotSize=parseInt(e.target.value); document.getElementById('dotLabel').textContent=dotSize; drawGrid(); });
document.getElementById('toggleCota').addEventListener('click',()=>{ cotaMode=!cotaMode; document.getElementById('toggleCota').textContent='Modo cota: '+(cotaMode?'ON':'OFF'); });
document.getElementById('undo').addEventListener('click',()=>{ if(cotaMode){ if(cotas.length) cotas.pop(); } else { if(lines.length) lines.pop(); } drawGrid(); });
document.getElementById('clear').addEventListener('click',()=>{ if(confirm('Borrar todo?')){ lines=[];cotas=[];drawGrid(); } });
document.getElementById('scaleSelect').addEventListener('change',e=>{
  scaleCM=parseFloat(e.target.value);
  rebuildPoints(); drawGrid();
});

document.getElementById('download').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'mm',format:'a4'});
  const startX=20, startY=20, step=10*scaleCM; // cada cuadrito mide scaleCM cm

  // puntos
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      pdf.circle(startX+c*step,startY+r*step,0.5,'F');
    }
  }

  // líneas
  lines.forEach(ln=>{
    const A={x:startX+(ln.a%cols)*step, y:startY+Math.floor(ln.a/cols)*step};
    const B={x:startX+(ln.b%cols)*step, y:startY+Math.floor(ln.b/cols)*step};
    pdf.setDrawColor(0,0,0);
    pdf.line(A.x,A.y,B.x,B.y);
  });

  // cotas
  cotas.forEach(ct=>{
    const A={x:startX+(ct.a%cols)*step, y:startY+Math.floor(ct.a/cols)*step};
    const B={x:startX+(ct.b%cols)*step, y:startY+Math.floor(ct.b/cols)*step};
    pdf.setDrawColor(0,0,0); pdf.setTextColor(0,0,0); pdf.setLineWidth(0.8); pdf.setFontSize(10);
    const arrowSize=flechaSize*0.5;

    if(A.y===B.y){ // horizontal
      const y=ct.pos==='arriba'? A.y-step*0.85 : A.y+step*0.85;
      pdf.line(A.x,A.y,B.x,B.y); pdf.line(A.x,y,A.x,A.y); pdf.line(B.x,y,B.x,B.y); pdf.line(A.x,y,B.x,y);
      pdf.line(A.x+arrowSize,y-arrowSize,A.x,y); pdf.line(A.x+arrowSize,y+arrowSize,A.x,y);
      pdf.line(B.x-arrowSize,y-arrowSize,B.x,y); pdf.line(B.x-arrowSize,y+arrowSize,B.x,y);
      pdf.text((Math.abs(B.x-A.x)/step*scaleCM).toFixed(1)+' cm',(A.x+B.x)/2,y-2,'center');
    } else { // vertical
      const x=ct.pos==='izquierda'? A.x-step*0.85 : A.x+step*0.85;
      pdf.line(A.x,A.y,B.x,B.y); pdf.line(A.x,A.y,x,A.y); pdf.line(B.x,B.y,x,B.y); pdf.line(x,A.y,x,B.y);
      pdf.line(x-arrowSize,A.y-arrowSize,x,A.y); pdf.line(x+arrowSize,A.y-arrowSize,x,A.y);
      pdf.line(x-arrowSize,B.y+arrowSize,x,B.y); pdf.line(x+arrowSize,B.y+arrowSize,x,B.y);
      pdf.saveGraphicsState();
      pdf.text((Math.abs(B.y-A.y)/step*scaleCM).toFixed(1)+' cm',x-2,(A.y+B.y)/2,'left',90);
      pdf.restoreGraphicsState();
    }
  });

  pdf.save('dibujo-planos.pdf');
});

function init(){ fixDPI(); rebuildPoints(); drawGrid(); }
window.addEventListener('resize',init);
init();
</script>
</body>
</html>
